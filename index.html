<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vault | Personal Cloud</title>
    <link rel="shortcut icon" id="dynamic-favicon" href="">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: "#020617",
                        card: "#0f172a",
                        glass: "rgba(15, 23, 42, 0.7)",
                        accent: "var(--accent-color)"
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <style>
        :root { 
            --accent-color: #6366f1; 
            --glass-bg: rgba(15, 23, 42, 0.95);
            --main-bg: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.4);
        }
        
        /* --- GAP FIX: STRICT LAYOUT CONTROL --- */
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* ডানে বামে স্ক্রল বন্ধ */
            position: fixed; /* বডি ফিক্সড করে রাখা */
            font-family: 'Inter', sans-serif; 
            background-color: var(--main-bg); 
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            transition: background-color 0.5s ease;
        }
        
        /* Mobile Wrapper */
        #mobile-wrapper {
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
            background-color: transparent; 
            height: 100%;
            position: relative;
            /* গ্যাপ ফিক্সের মূল চাবিকাঠি */
            overflow: hidden; 
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            border-left: 1px solid rgba(255,255,255,0.05);
            border-right: 1px solid rgba(255,255,255,0.05);
        }

        #app-screen {
            background: rgba(15, 23, 42, 0.85);
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            width: 100%;
            height: 100%;
        }

        /* সেটিংস প্যানেল পজিশন ফিক্স */
        #settings-panel {
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            width: 280px; /* ফিক্সড উইডথ */
            background-color: var(--glass-bg);
            backdrop-filter: blur(20px);
            z-index: 70;
            transform: translateX(100%); /* স্ক্রিনের বাইরে */
            transition: transform 0.3s ease-in-out;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* যখন প্যানেল ওপেন হবে */
        #settings-panel.open {
            transform: translateX(0);
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            transition: background 0.5s ease;
        }
        
        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }
        .glass-card:hover {
            background: rgba(30, 41, 59, 0.6);
            border-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        .spinner { border: 3px solid rgba(255,255,255,0.1); border-left-color: var(--accent-color); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .fade-enter-active { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        input:read-only, textarea:read-only {
            background-color: rgba(15, 23, 42, 0.5) !important;
            border-color: transparent !important;
            color: #cbd5e1 !important;
            cursor: text;
        }
        
        .input-wrapper { position: relative; }
        .input-icon {
            position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
            color: #64748b; font-size: 14px; pointer-events: none; z-index: 10;
        }
        textarea ~ .input-icon { top: 12px; transform: none; }
        .req-dot { color: #f43f5e; font-size: 16px; margin-left: 3px; font-weight: bold; }

        .dropdown-content {
            max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, opacity 0.3s ease; opacity: 0;
        }
        .dropdown-content.open {
            max-height: 800px; opacity: 1; transition: max-height 0.5s ease-in, opacity 0.5s ease;
        }
        .rotate-icon { transition: transform 0.3s ease; }
        .rotate-icon.open { transform: rotate(180deg); }
        .dynamic-bg { background-color: var(--card-bg); transition: background-color 0.5s ease; }

        #startup-loader {
            position: fixed; inset: 0; z-index: 9999;
            background: #020617; display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease;
        }

        /* Doll Style Buttons */
        .color-doll {
            width: 24px; height: 24px; border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.1);
            transition: transform 0.2s; cursor: pointer;
            position: relative;
        }
        .color-doll:hover { transform: scale(1.2); border-color: white; z-index: 10; }
        
        .settings-header-btn {
            width: 100%; display: flex; justify-content: space-between; align-items: center;
            font-size: 10px; font-weight: bold; color: #64748b;
            text-transform: uppercase; letter-spacing: 1px; padding: 12px 0;
        }
        .settings-header-btn:hover { color: white; }
        
        .setting-label { font-size: 9px; color: #94a3b8; font-weight: bold; text-transform: uppercase; margin-bottom: 6px; display: block; }
        
        .sub-group-title {
            font-size: 9px; color: var(--accent-color); font-weight: 800; text-transform: uppercase; margin-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 2px;
        }
    </style>
</head>
<body class="text-slate-200 h-screen overflow-hidden flex justify-center selection:bg-indigo-500 selection:text-white">

    <div id="startup-loader">
        <div class="spinner border-t-4 border-indigo-500 w-12 h-12"></div>
    </div>

    <!-- Mobile Wrapper -->
    <div id="mobile-wrapper">

        <!-- LOGIN SCREEN -->
        <div id="auth-screen" class="hidden absolute inset-0 z-[100] flex items-center justify-center bg-dark/95 backdrop-blur-xl">
            <div class="glass-panel p-8 rounded-2xl w-full max-w-sm mx-4 shadow-2xl relative overflow-hidden border border-white/10">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-[var(--accent-color)] to-transparent"></div>
                <div class="text-center mb-8">
                    <div class="w-16 h-16 mx-auto bg-slate-800/50 rounded-full flex items-center justify-center mb-4 shadow-inner border border-white/5">
                        <i class="fa-solid fa-vault text-3xl text-[var(--accent-color)]"></i>
                    </div>
                    <h1 class="text-3xl font-bold tracking-tight text-white">Private Vault</h1>
                    <p class="text-slate-400 text-sm mt-2">Secure Personal Cloud</p>
                </div>
                <form id="login-form" class="space-y-4">
                    <div class="relative">
                        <i class="fa-solid fa-envelope absolute left-4 top-1/2 -translate-y-1/2 text-slate-500"></i>
                        <input type="email" id="email" placeholder="Email Address" class="w-full bg-slate-900/60 border border-slate-700 rounded-xl pl-10 px-4 py-3 text-sm focus:outline-none focus:border-[var(--accent-color)] transition" required>
                    </div>
                    <div class="relative">
                        <i class="fa-solid fa-lock absolute left-4 top-1/2 -translate-y-1/2 text-slate-500"></i>
                        <input type="password" id="password" placeholder="Password" class="w-full bg-slate-900/60 border border-slate-700 rounded-xl pl-10 px-4 py-3 text-sm focus:outline-none focus:border-[var(--accent-color)] transition" required>
                    </div>
                    <button type="submit" class="w-full bg-[var(--accent-color)] hover:opacity-90 text-white font-semibold py-3 rounded-xl shadow-lg shadow-indigo-500/20 transition-all mt-2 flex justify-center items-center gap-2">
                        Unlock Vault
                    </button>
                </form>
                <div id="auth-msg" class="text-rose-400 text-xs text-center mt-4 h-4 font-medium"></div>
            </div>
        </div>

        <!-- MAIN APP -->
        <div id="app-screen" class="hidden">
            
            <!-- Navbar -->
            <nav class="glass-panel h-[70px] flex items-center justify-between px-4 z-20 sticky top-0 shrink-0 shadow-sm transition-all w-full">
                <div class="flex items-center gap-2.5">
                    <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-[var(--accent-color)] to-purple-800 flex items-center justify-center text-white shadow-lg shadow-indigo-500/20 border border-white/10 shrink-0">
                        <i class="fa-solid fa-shield-cat text-xs"></i>
                    </div>
                    <div class="flex flex-col justify-center whitespace-nowrap">
                        <span class="font-bold text-base tracking-wide text-white font-mono leading-none">VAULT<span class="text-[var(--accent-color)]">.IO</span></span>
                        <span class="text-[8px] text-slate-400 tracking-wider font-medium block mt-0.5">SECURE CLOUD</span>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="relative flex items-center justify-end">
                        <input type="text" id="search-input" 
                            class="bg-slate-800/50 border border-white/10 rounded-full w-9 h-9 text-transparent placeholder-transparent 
                                   focus:w-32 focus:h-9 focus:bg-slate-900 focus:text-slate-200 focus:placeholder-slate-500 
                                   focus:pl-4 focus:pr-8 focus:border-[var(--accent-color)] 
                                   transition-all duration-500 ease-out outline-none cursor-pointer focus:cursor-text z-10 peer shadow-inner text-[11px]"
                            placeholder="Search..."
                        >
                        <i class="fa-solid fa-search absolute right-3 text-slate-400 text-xs z-0 pointer-events-none peer-focus:text-[var(--accent-color)] transition-colors duration-300"></i>
                    </div>
                    <button onclick="toggleSettings()" class="w-9 h-9 rounded-full bg-slate-800/50 hover:bg-slate-700 flex items-center justify-center text-slate-300 transition-all border border-white/10 active:scale-90 shrink-0">
                        <i class="fa-solid fa-bars-staggered text-xs"></i>
                    </button>
                </div>
            </nav>

            <!-- Settings Panel -->
            <div id="settings-backdrop" onclick="toggleSettings()" class="absolute inset-0 bg-black/60 z-[60] hidden backdrop-blur-sm transition-opacity"></div>
            <div id="settings-panel" class="flex flex-col">
                <div class="p-5 border-b border-white/5 flex justify-between items-center bg-slate-900/50 shrink-0">
                    <h2 class="text-base font-bold text-white">Settings</h2>
                    <button onclick="toggleSettings()" class="text-slate-400 hover:text-white w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-800 transition"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="p-5 flex-1 overflow-y-auto space-y-4">
                    
                    <!-- Profile Info -->
                    <div class="text-center p-4 rounded-xl border border-white/5 dynamic-bg">
                        <div onclick="updateProfilePic()" class="w-20 h-20 mx-auto rounded-full bg-gradient-to-tr from-[var(--accent-color)] to-purple-600 p-[2px] mb-3 cursor-pointer group relative">
                            <div class="w-full h-full rounded-full bg-slate-900 flex items-center justify-center overflow-hidden relative">
                                <i id="settings-icon" class="fa-solid fa-user text-2xl text-slate-200"></i>
                                <img id="settings-avatar" src="" class="w-full h-full object-cover absolute inset-0 hidden">
                                <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                                    <i class="fa-solid fa-camera text-white text-lg"></i>
                                </div>
                            </div>
                        </div>
                        <p id="user-email" class="text-xs font-medium text-white truncate">user@email.com</p>
                    </div>

                    <!-- 1. VISUAL ASSETS -->
                    <div class="border-b border-white/5 pb-2">
                        <button onclick="toggleDropdown('assets-dropdown', 'assets-icon')" class="settings-header-btn group">
                            <span>Visual Assets</span>
                            <i id="assets-icon" class="fa-solid fa-chevron-down rotate-icon"></i>
                        </button>
                        <div id="assets-dropdown" class="dropdown-content">
                            <div class="p-3 bg-slate-900/30 rounded-xl border border-white/5 space-y-4 mb-2">
                                
                                <!-- Body Wallpaper -->
                                <div>
                                    <span class="setting-label">Body Wallpaper</span>
                                    <div class="flex gap-2">
                                        <input type="text" id="custom-bg-input" placeholder="URL..." class="w-full bg-slate-800/50 border border-slate-700 rounded p-1.5 text-[10px] text-white focus:outline-none focus:border-[var(--accent-color)]">
                                        <button onclick="saveBackground()" class="bg-[var(--accent-color)] text-white px-2.5 rounded text-[10px] hover:brightness-110"><i class="fa-solid fa-check"></i></button>
                                        <button onclick="resetBackground()" class="bg-rose-500/20 text-rose-400 px-2.5 rounded text-[10px] hover:bg-rose-500 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
                                    </div>
                                </div>

                                <!-- Content Wallpaper -->
                                <div>
                                    <span class="setting-label">Content Wallpaper</span>
                                    <div class="flex gap-2">
                                        <input type="text" id="content-bg-input" placeholder="URL..." class="w-full bg-slate-800/50 border border-slate-700 rounded p-1.5 text-[10px] text-white focus:outline-none focus:border-[var(--accent-color)]">
                                        <button onclick="saveContentBg()" class="bg-[var(--accent-color)] text-white px-2.5 rounded text-[10px] hover:brightness-110"><i class="fa-solid fa-check"></i></button>
                                        <button onclick="resetContentBg()" class="bg-rose-500/20 text-rose-400 px-2.5 rounded text-[10px] hover:bg-rose-500 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
                                    </div>
                                </div>

                                <!-- App Logo -->
                                <div>
                                    <span class="setting-label">App Logo / Icon</span>
                                    <div class="flex gap-2">
                                        <input type="text" id="custom-logo-input" placeholder="URL..." class="w-full bg-slate-800/50 border border-slate-700 rounded p-1.5 text-[10px] text-white focus:outline-none focus:border-[var(--accent-color)]">
                                        <button onclick="saveLogo()" class="bg-[var(--accent-color)] text-white px-2.5 rounded text-[10px] hover:brightness-110"><i class="fa-solid fa-check"></i></button>
                                        <button onclick="resetLogo()" class="bg-rose-500/20 text-rose-400 px-2.5 rounded text-[10px] hover:bg-rose-500 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                    <!-- 2. COLOR THEME -->
                    <div class="border-b border-white/5 pb-2">
                        <button onclick="toggleDropdown('color-theme-dropdown', 'color-theme-icon')" class="settings-header-btn group">
                            <span>Color Theme</span>
                            <i id="color-theme-icon" class="fa-solid fa-chevron-down rotate-icon"></i>
                        </button>
                        <div id="color-theme-dropdown" class="dropdown-content">
                            <div class="p-3 bg-slate-900/30 rounded-xl border border-white/5 space-y-4 mb-2">
                                
                                <!-- Accent Color -->
                                <div>
                                    <div class="sub-group-title">Accent Color</div>
                                    <div class="flex flex-wrap gap-2 justify-start">
                                        <div onclick="setAccent('#6366f1')" class="color-doll bg-indigo-500"></div>
                                        <div onclick="setAccent('#10b981')" class="color-doll bg-emerald-500"></div>
                                        <div onclick="setAccent('#f43f5e')" class="color-doll bg-rose-500"></div>
                                        <div onclick="setAccent('#f59e0b')" class="color-doll bg-amber-500"></div>
                                        <div onclick="setAccent('#06b6d4')" class="color-doll bg-cyan-500"></div>
                                        <div onclick="setAccent('#d946ef')" class="color-doll bg-fuchsia-500"></div>
                                        <div onclick="setAccent('#ea580c')" class="color-doll bg-orange-600"></div>
                                        <button onclick="setCustomColor('accent')" class="color-doll border-dashed border-slate-400 flex items-center justify-center text-[8px] text-slate-400 hover:text-white"><i class="fa-solid fa-plus"></i></button>
                                    </div>
                                </div>

                                <!-- Theme BG (Page) -->
                                <div>
                                    <div class="sub-group-title">Theme BG (Page)</div>
                                    <div class="flex flex-wrap gap-2 justify-start">
                                        <div onclick="setGlassBg('rgba(15, 23, 42, 0.95)', '#0f172a')" class="color-doll bg-[#0f172a]" title="Slate"></div>
                                        <div onclick="setGlassBg('rgba(0, 0, 0, 0.95)', '#000000')" class="color-doll bg-black" title="Black"></div>
                                        <div onclick="setGlassBg('rgba(23, 37, 84, 0.95)', '#172554')" class="color-doll bg-blue-950" title="Blue"></div>
                                        <div onclick="setGlassBg('rgba(69, 10, 10, 0.95)', '#450a0a')" class="color-doll bg-red-950" title="Red"></div>
                                        <div onclick="setGlassBg('rgba(2, 44, 34, 0.95)', '#022c22')" class="color-doll bg-emerald-950" title="Green"></div>
                                        <div onclick="setGlassBg('rgba(38, 30, 25, 0.95)', '#261e19')" class="color-doll bg-[#261e19]" title="Coffee"></div>
                                        <button onclick="setCustomColor('main')" class="color-doll border-dashed border-slate-400 flex items-center justify-center text-[8px] text-slate-400 hover:text-white"><i class="fa-solid fa-plus"></i></button>
                                    </div>
                                </div>

                                <!-- Item BG (Cards) -->
                                <div>
                                    <div class="sub-group-title">Item BG (Cards)</div>
                                    <div class="flex flex-wrap gap-2 justify-start">
                                        <div onclick="setCardBg('rgba(30, 41, 59, 0.4)')" class="color-doll bg-slate-700" title="Default"></div>
                                        <div onclick="setCardBg('rgba(0, 0, 0, 0.6)')" class="color-doll bg-black/60" title="Dark"></div>
                                        <div onclick="setCardBg('rgba(255, 255, 255, 0.1)')" class="color-doll bg-white/20" title="Frost"></div>
                                        <div onclick="setCardBg('rgba(30, 58, 138, 0.4)')" class="color-doll bg-blue-900" title="Blue Tint"></div>
                                        <div onclick="setCardBg('rgba(88, 28, 135, 0.4)')" class="color-doll bg-purple-900" title="Purple Tint"></div>
                                        <button onclick="setCustomColor('card')" class="color-doll border-dashed border-slate-400 flex items-center justify-center text-[8px] text-slate-400 hover:text-white"><i class="fa-solid fa-plus"></i></button>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                    <!-- Security -->
                    <div class="pt-2">
                        <h3 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-3">Security</h3>
                        <div class="space-y-2">
                            <input type="password" id="new-password-input" placeholder="New Password" class="w-full bg-slate-800/40 border border-slate-700 rounded-lg px-3 py-2 text-xs focus:border-[var(--accent-color)] focus:outline-none text-white">
                            <button onclick="updateUserPassword()" class="w-full py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-300 text-[10px] font-bold border border-white/5 transition">UPDATE PASSWORD</button>
                        </div>
                    </div>

                    <!-- Data -->
                    <div class="border-t border-white/5 pt-4">
                        <button onclick="backupData()" class="w-full flex items-center justify-between p-3 rounded-xl bg-slate-800/40 hover:bg-slate-800 border border-white/5 transition text-xs text-slate-300 group mb-2">
                            <span><i class="fa-solid fa-cloud-download-alt mr-2 text-[var(--accent-color)]"></i> Backup Data (JSON)</span>
                        </button>
                    </div>

                </div>
                <div class="p-5 border-t border-white/5 bg-slate-900/30">
                    <button onclick="logout()" class="w-full py-2.5 rounded-xl border border-rose-500/30 text-rose-400 hover:bg-rose-500/10 transition text-xs font-bold uppercase tracking-wide">Sign Out</button>
                </div>
            </div>

            <!-- Content Area -->
            <main class="flex-1 overflow-y-auto p-5 relative scroll-smooth z-10 w-full">
                <!-- Dashboard View -->
                <div id="dashboard-view" class="hidden fade-enter-active pb-20">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-xl font-bold text-white">Dashboard</h2>
                            <p class="text-[10px] text-slate-400 font-mono flex items-center gap-2">Overview 
                                <span id="total-storage" class="px-1.5 py-0.5 rounded bg-emerald-500/20 text-emerald-400 font-bold border border-emerald-500/20 text-[9px]">0 KB</span>
                            </p>
                        </div>
                        <button onclick="openModal()" class="w-9 h-9 rounded-full bg-[var(--accent-color)] hover:brightness-110 text-white shadow-lg shadow-indigo-500/20 flex items-center justify-center transition-transform hover:scale-105 active:scale-95 group z-40 relative">
                            <i class="fa-solid fa-plus text-xs group-hover:rotate-90 transition-transform duration-300"></i>
                        </button>
                    </div>

                    <!-- Stat Cards Grid -->
                    <div class="grid grid-cols-2 gap-3">
                        <div onclick="switchCategory('notes')" class="glass-card p-4 rounded-xl cursor-pointer group border-l-4 border-l-indigo-500/50">
                            <div class="flex justify-between items-start mb-2">
                                <div class="p-2 rounded-lg bg-indigo-500/10 text-indigo-400 group-hover:bg-indigo-500 group-hover:text-white transition"><i class="fa-solid fa-note-sticky text-base"></i></div>
                                <div class="text-right">
                                    <span class="text-lg font-bold text-white block leading-none" id="count-notes">0</span>
                                    <span id="size-notes" class="text-[9px] font-bold text-emerald-400 bg-emerald-500/20 px-1.5 py-0.5 rounded border border-emerald-500/10">0 KB</span>
                                </div>
                            </div>
                            <p class="text-xs text-slate-400 font-medium">Notes</p>
                        </div>
                        <div onclick="switchCategory('links')" class="glass-card p-4 rounded-xl cursor-pointer group border-l-4 border-l-emerald-500/50">
                            <div class="flex justify-between items-start mb-2">
                                <div class="p-2 rounded-lg bg-emerald-500/10 text-emerald-400 group-hover:bg-emerald-500 group-hover:text-white transition"><i class="fa-solid fa-link text-base"></i></div>
                                <div class="text-right">
                                    <span class="text-lg font-bold text-white block leading-none" id="count-links">0</span>
                                    <span id="size-links" class="text-[9px] font-bold text-emerald-400 bg-emerald-500/20 px-1.5 py-0.5 rounded border border-emerald-500/10">0 KB</span>
                                </div>
                            </div>
                            <p class="text-xs text-slate-400 font-medium">Links</p>
                        </div>
                        <div onclick="switchCategory('credentials')" class="glass-card p-4 rounded-xl cursor-pointer group col-span-2 border-l-4 border-l-amber-500/50">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="p-2 rounded-lg bg-amber-500/10 text-amber-400 group-hover:bg-amber-500 group-hover:text-white transition"><i class="fa-solid fa-user-shield text-base"></i></div>
                                    <div>
                                        <p class="text-xs text-slate-400 font-medium">User</p>
                                        <p class="text-[10px] text-slate-500">Logins & Info</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span id="size-credentials" class="text-[9px] font-bold text-emerald-400 bg-emerald-500/20 px-1.5 py-0.5 rounded border border-emerald-500/10">0 KB</span>
                                    <span class="text-xl font-bold text-white pr-2" id="count-credentials">0</span>
                                </div>
                            </div>
                        </div>
                        <div onclick="switchCategory('photos')" class="glass-card p-4 rounded-xl cursor-pointer group col-span-2 border-l-4 border-l-pink-500/50">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="p-2 rounded-lg bg-pink-500/10 text-pink-400 group-hover:bg-pink-500 group-hover:text-white transition"><i class="fa-solid fa-image text-base"></i></div>
                                    <div>
                                        <p class="text-xs text-slate-400 font-medium">Saved Images</p>
                                        <p class="text-[10px] text-slate-500">Gallery Links</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span id="size-photos" class="text-[9px] font-bold text-emerald-400 bg-emerald-500/20 px-1.5 py-0.5 rounded border border-emerald-500/10">0 KB</span>
                                    <span class="text-xl font-bold text-white pr-2" id="count-photos">0</span>
                                </div>
                            </div>
                        </div>
                        <div onclick="switchCategory('apis')" class="glass-card p-4 rounded-xl cursor-pointer group col-span-2 border-l-4 border-l-cyan-500/50">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="p-2 rounded-lg bg-cyan-500/10 text-cyan-400 group-hover:bg-cyan-500 group-hover:text-white transition"><i class="fa-solid fa-network-wired text-base"></i></div>
                                    <div>
                                        <p class="text-xs text-slate-400 font-medium">API Manager</p>
                                        <p class="text-[10px] text-slate-500">Endpoints & Keys</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span id="size-apis" class="text-[9px] font-bold text-emerald-400 bg-emerald-500/20 px-1.5 py-0.5 rounded border border-emerald-500/10">0 KB</span>
                                    <span class="text-xl font-bold text-white pr-2" id="count-apis">0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8">
                        <div class="glass-card p-5 rounded-xl text-center text-slate-400 border border-dashed border-slate-700 bg-slate-900/20">
                            <i class="fa-solid fa-shield-halved text-2xl mb-2 opacity-30 text-[var(--accent-color)]"></i>
                            <p class="text-[10px] font-mono opacity-50 uppercase tracking-widest">End-to-End Encrypted</p>
                        </div>
                    </div>
                </div>

                <!-- List View Header -->
                <div id="list-header" class="flex justify-between items-end mb-4 fade-enter-active hidden">
                    <div>
                        <h2 class="text-xl font-bold text-white capitalize tracking-tight" id="page-title">Notes</h2>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="w-1.5 h-1.5 rounded-full bg-[var(--accent-color)]"></span>
                            <p class="text-[10px] text-slate-400 font-mono uppercase" id="item-count">Loading...</p>
                        </div>
                    </div>
                    <div class="flex bg-slate-800/50 p-1 rounded-lg border border-white/5">
                        <button onclick="toggleView('grid')" class="text-slate-400 hover:text-white p-1.5 rounded hover:bg-slate-700/50 transition"><i class="fa-solid fa-grid-2 text-xs"></i></button>
                        <button onclick="toggleView('list')" class="text-slate-400 hover:text-white p-1.5 rounded hover:bg-slate-700/50 transition"><i class="fa-solid fa-list text-xs"></i></button>
                    </div>
                </div>

                <!-- Loader -->
                <div id="loader-state" class="hidden flex justify-center py-20">
                    <div class="spinner"></div>
                </div>

                <!-- Content Grid -->
                <div id="content-grid" class="grid grid-cols-1 gap-3 pb-20 hidden"></div>

                <!-- Empty State -->
                <div id="empty-state" class="hidden flex flex-col items-center justify-center py-16 opacity-50">
                    <div class="w-16 h-16 bg-slate-800/50 rounded-full flex items-center justify-center mb-3 border border-slate-700 border-dashed">
                        <i class="fa-solid fa-box-open text-2xl text-slate-500"></i>
                    </div>
                    <p class="text-sm text-slate-500">No items found</p>
                    <button onclick="openModal()" class="mt-4 text-xs text-[var(--accent-color)] hover:underline font-bold">CREATE NEW</button>
                </div>
            </main>

            <!-- Bottom Nav -->
            <div id="bottom-navbar" class="shrink-0 px-2 py-2 border-t border-white/5 grid grid-cols-5 gap-1 backdrop-blur-md z-50 transition-all duration-300 w-full" style="background: var(--glass-bg)">
                <button onclick="switchCategory('dashboard')" class="mobile-nav-btn flex flex-col items-center justify-center py-2 rounded-xl text-[10px] font-medium bg-[var(--accent-color)] text-white shadow-lg transition-all duration-300">
                    <i class="fa-solid fa-house mb-0.5 text-sm"></i>Home
                </button>
                <button onclick="switchCategory('notes')" class="mobile-nav-btn flex flex-col items-center justify-center py-2 rounded-xl text-[10px] font-medium text-slate-400 border border-slate-700/50 transition-all duration-300 dynamic-bg">
                    <i class="fa-solid fa-note-sticky mb-0.5 text-sm"></i>Note
                </button>
                <button onclick="switchCategory('photos')" class="mobile-nav-btn flex flex-col items-center justify-center py-2 rounded-xl text-[10px] font-medium text-slate-400 border border-slate-700/50 transition-all duration-300 dynamic-bg">
                    <i class="fa-solid fa-image mb-0.5 text-sm"></i>Img
                </button>
                <button onclick="switchCategory('links')" class="mobile-nav-btn flex flex-col items-center justify-center py-2 rounded-xl text-[10px] font-medium text-slate-400 border border-slate-700/50 transition-all duration-300 dynamic-bg">
                    <i class="fa-solid fa-link mb-0.5 text-sm"></i>Link
                </button>
                <button onclick="switchCategory('credentials')" class="mobile-nav-btn flex flex-col items-center justify-center py-2 rounded-xl text-[10px] font-medium text-slate-400 border border-slate-700/50 transition-all duration-300 dynamic-bg">
                    <i class="fa-solid fa-user-shield mb-0.5 text-sm"></i>User
                </button>
            </div>
            
            <!-- Toast Notification -->
            <div id="toast" class="absolute top-[80px] left-1/2 -translate-x-1/2 z-[90] glass-panel px-4 py-3 rounded-full shadow-2xl transition-all duration-300 flex items-center gap-3 border border-[var(--accent-color)] w-max max-w-[90%] opacity-0 -translate-y-4 pointer-events-none">
                <div class="w-5 h-5 rounded-full bg-[var(--accent-color)] flex items-center justify-center text-white text-xs"><i class="fa-solid fa-check"></i></div>
                <p id="toast-msg" class="text-xs text-white font-medium">Success</p>
            </div>

        </div>
    </div>

    <!-- MODAL -->
    <div id="main-modal" class="absolute inset-0 z-[80] bg-black/80 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="glass-panel p-5 rounded-2xl w-full max-w-[340px] transform scale-95 opacity-0 transition-all duration-300 border border-white/10 shadow-2xl flex flex-col" id="modal-content">
            <!-- Header -->
            <div class="flex justify-between items-center mb-4 border-b border-white/5 pb-3 shrink-0">
                <h3 class="text-lg font-bold text-white flex items-center gap-2"><span id="modal-title">New Entry</span></h3>
                <button type="button" onclick="closeModal()" class="w-8 h-8 rounded-full bg-rose-500 hover:bg-rose-600 flex items-center justify-center text-white shadow-lg transition transform hover:rotate-90"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <!-- Category Selector -->
            <div id="modal-cat-select" class="grid grid-cols-5 gap-1.5 mb-4 shrink-0">
                <button onclick="setModalType('notes')" class="modal-cat-btn flex flex-col items-center justify-center p-2 rounded-lg bg-[var(--accent-color)] text-white text-[9px] border border-transparent shadow-lg transition"><i class="fa-solid fa-note-sticky mb-1 text-sm"></i> Note</button>
                <button onclick="setModalType('links')" class="modal-cat-btn flex flex-col items-center justify-center p-2 rounded-lg bg-slate-800 text-slate-400 hover:bg-slate-700 text-[9px] border border-slate-700 transition"><i class="fa-solid fa-link mb-1 text-sm"></i> Link</button>
                <button onclick="setModalType('photos')" class="modal-cat-btn flex flex-col items-center justify-center p-2 rounded-lg bg-slate-800 text-slate-400 hover:bg-slate-700 text-[9px] border border-slate-700 transition"><i class="fa-solid fa-image mb-1 text-sm"></i> Img</button>
                <button onclick="setModalType('credentials')" class="modal-cat-btn flex flex-col items-center justify-center p-2 rounded-lg bg-slate-800 text-slate-400 hover:bg-slate-700 text-[9px] border border-slate-700 transition"><i class="fa-solid fa-user-shield mb-1 text-sm"></i> User</button>
                <button onclick="setModalType('apis')" class="modal-cat-btn flex flex-col items-center justify-center p-2 rounded-lg bg-slate-800 text-slate-400 hover:bg-slate-700 text-[9px] border border-slate-700 transition"><i class="fa-solid fa-network-wired mb-1 text-sm"></i> API</button>
            </div>
            <!-- Form -->
            <form id="entry-form" class="space-y-3 flex-1 flex flex-col overflow-hidden">
                <input type="hidden" id="entry-id">
                <div class="shrink-0 input-wrapper">
                    <div class="flex justify-between items-end mb-1">
                        <label class="block text-[10px] text-[var(--accent-color)] uppercase font-bold tracking-wider ml-1">Title (Optional)</label>
                        <button type="button" onclick="copyFromId('inp-title')" class="modal-copy-btn text-xs text-slate-500 hover:text-white transition flex items-center gap-1 hidden"><i class="fa-regular fa-copy"></i></button>
                    </div>
                    <div class="relative">
                        <i class="fa-solid fa-heading input-icon"></i>
                        <input type="text" id="inp-title" placeholder="Entry Title" class="w-full bg-slate-900/80 border border-slate-700 rounded-lg pl-10 px-3 py-2 text-sm focus:border-[var(--accent-color)] focus:outline-none transition text-white">
                    </div>
                </div>
                <!-- Content Fields -->
                <div class="field-group hidden flex-1 flex flex-col h-full" data-for="notes">
                    <div class="flex justify-between items-end mb-1">
                        <label class="block text-[10px] text-[var(--accent-color)] uppercase font-bold tracking-wider ml-1">Content <span class="req-dot">*</span></label>
                        <button type="button" onclick="copyFromId('inp-content')" class="modal-copy-btn text-xs text-slate-500 hover:text-white transition flex items-center gap-1 hidden"><i class="fa-regular fa-copy"></i></button>
                    </div>
                    <div class="relative flex-1">
                        <i class="fa-solid fa-align-left input-icon top-4 translate-y-0"></i>
                        <textarea id="inp-content" class="w-full h-full bg-slate-900/80 border border-slate-700 rounded-lg pl-10 px-3 py-2 text-sm focus:border-[var(--accent-color)] focus:outline-none font-mono text-slate-300 resize-none"></textarea>
                    </div>
                </div>
                <!-- API Fields -->
                <div class="field-group hidden shrink-0" data-for="apis">
                    <div class="mb-2">
                        <div class="flex justify-between items-end mb-1"><label class="block text-[10px] text-[var(--accent-color)] uppercase font-bold tracking-wider ml-1">Endpoint URL (Optional)</label><button type="button" onclick="copyFromId('inp-api-url')" class="modal-copy-btn text-xs text-slate-500 hover:text-white transition flex items-center gap-1 hidden"><i class="fa-regular fa-copy"></i></button></div>
                        <div class="relative"><i class="fa-solid fa-globe input-icon"></i><input type="url" id="inp-api-url" placeholder="https://api.example.com/v1/" class="w-full bg-slate-900/80 border border-slate-700 rounded-lg pl-10 px-3 py-2 text-sm focus:border-[var(--accent-color)] focus:outline-none text-white font-mono"></div>
                    </div>
                    <div class="mb-2">
                        <div class="flex justify-between items-end mb-1"><label class="block text-[10px] text-[var(--accent-color)] uppercase font-bold tracking-wider ml-1">Gmail (Optional)</label><button type="button" onclick="copyFromId('inp-api-email')" class="modal-copy-btn text-xs text-slate-500 hover:text-white transition flex items-center gap-1 hidden"><i class="fa-regular fa-copy"></i></button></div>
                        <div class="relative"><i class="fa-solid fa-envelope input-icon"></i><input type="email" id="inp-api-email" placeholder="dev@example.com" class="w-full bg-slate-900/80 border border-slate-700 rounded-lg pl-10 px-3 py-2 text-sm focus:border-[var(--accent-color)] focus:outline-none text-white"></div>
                    </div>
                    <div>
                        <div class="flex justify-between items-end mb-1"><label class="block text-[10px] text-[var(--accent-color)] uppercase font-bold tracking-wider ml-1">API Key / Token <span class="req-dot">*</span></label><button type="button" onclick="copyFromId('inp-api-key')" class="modal-copy-btn text-xs text-slate-500 hover:text-white transition flex items-center gap-1 hidden"><i class="fa-regular fa-copy"></i></button></div>
                        <div class="relative"><i class="fa-solid fa-key input-icon top-4 translate-y-0"></i><textarea id="inp-api-key" rows="3" placeholder="Bearer..." class="w-full bg-slate-900/80 border border-slate-700 rounded-lg pl-10 px-3 py-2 text-xs focus:border-[var(--accent-color)] focus:outline-none font-mono text-emerald-400"></textarea></div>
                    </div>
                </div>
                <!-- Link Fields -->
                <div class="field-group hidden shrink-0" data-for="links">
                    <div class="mb-1">
                        <div class="flex justify-between items-end mb-1"><label class="block text-[10px] text-[var(--accent-color)] uppercase font-bold tracking-wider ml-1">URL <span class="req-dot">*</span></label><button type="button" onclick="copyFromId('inp-url')" class="modal-copy-btn text-xs text-slate-500 hover:text-white transition flex items-center gap-1 hidden"><i class="fa-regular fa-copy"></i></button></div>
                        <div class="relative"><i class="fa-solid fa-link input-icon"></i><input type="url" id="inp-url" placeholder="https://" class="w-full bg-slate-900/80 border border-slate-700 rounded-lg pl-10 px-3 py-2 text-sm focus:border-[var(--accent-color)] focus:outline-none text-white"></div>
                    </div>
                </div>
                <!-- Photo Fields -->
                <div class="field-group hidden shrink-0" data-for="photos">
                    <div class="mb-1">
                        <div class="flex justify-between items-end mb-1"><label class="block text-[10px] text-[var(--accent-color)] uppercase font-bold tracking-wider ml-1">Image URL <span class="req-dot">*</span></label><button type="button" onclick="copyFromId('inp-img-url')" class="modal-copy-btn text-xs text-slate-500 hover:text-white transition flex items-center gap-1 hidden"><i class="fa-regular fa-copy"></i></button></div>
                        <div class="relative"><i class="fa-regular fa-image input-icon"></i><input type="url" id="inp-img-url" placeholder="https://" class="w-full bg-slate-900/80 border border-slate-700 rounded-lg pl-10 px-3 py-2 text-sm focus:border-[var(--accent-color)] focus:outline-none text-white"></div>
                    </div>
                </div>
                <!-- Credential Fields -->
                <div class="field-group hidden shrink-0" data-for="credentials">
                    <div class="mb-3">
                        <div class="flex justify-between items-end mb-1"><label class="block text-[10px] text-[var(--accent-color)] uppercase font-bold tracking-wider ml-1">Website/Link (Optional)</label><button type="button" onclick="copyFromId('inp-cred-url')" class="modal-copy-btn text-xs text-slate-500 hover:text-white transition flex items-center gap-1 hidden"><i class="fa-regular fa-copy"></i></button></div>
                        <div class="relative"><i class="fa-solid fa-link input-icon"></i><input type="url" id="inp-cred-url" placeholder="https://" class="w-full bg-slate-900/80 border border-slate-700 rounded-lg pl-10 px-3 py-2 text-sm focus:border-[var(--accent-color)] focus:outline-none text-white"></div>
                    </div>
                    <div class="mb-3">
                        <div class="flex justify-between items-end mb-1"><label class="block text-[10px] text-[var(--accent-color)] uppercase font-bold tracking-wider ml-1">Username <span class="req-dot">*</span></label><button type="button" onclick="copyFromId('inp-username')" class="modal-copy-btn text-xs text-slate-500 hover:text-white transition flex items-center gap-1 hidden"><i class="fa-regular fa-copy"></i></button></div>
                        <div class="relative"><i class="fa-solid fa-user input-icon"></i><input type="text" id="inp-username" class="w-full bg-slate-900/80 border border-slate-700 rounded-lg pl-10 px-3 py-2 text-sm focus:border-[var(--accent-color)] focus:outline-none text-white"></div>
                    </div>
                    <div>
                        <div class="flex justify-between items-end mb-1"><label class="block text-[10px] text-[var(--accent-color)] uppercase font-bold tracking-wider ml-1">Password <span class="req-dot">*</span></label><button type="button" onclick="copyFromId('inp-password')" class="modal-copy-btn text-xs text-slate-500 hover:text-white transition flex items-center gap-1 hidden"><i class="fa-regular fa-copy"></i></button></div>
                        <div class="relative"><i class="fa-solid fa-lock input-icon"></i><input type="password" id="inp-password" class="w-full bg-slate-900/80 border border-slate-700 rounded-lg pl-10 px-3 py-2 text-sm focus:border-[var(--accent-color)] focus:outline-none font-mono text-white"><i id="toggle-pass-btn" onclick="togglePassVisibility(this)" class="fa-solid fa-eye absolute right-3 top-1/2 -translate-y-1/2 cursor-pointer text-slate-500 hover:text-white transition text-xs"></i></div>
                    </div>
                </div>
                <div class="flex justify-end gap-2 pt-4 border-t border-white/5 mt-auto shrink-0">
                    <button type="submit" id="btn-save" class="bg-[var(--accent-color)] hover:brightness-110 text-white px-6 py-2 rounded-lg text-xs font-bold shadow-lg shadow-indigo-500/20">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getDatabase, ref, push, set, onValue, remove, update, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDzlvAxm4nAOsLQykYVbTnJBeFdfaaHxkU",
            authDomain: "data-manager-af3dc.firebaseapp.com",
            databaseURL: "https://data-manager-af3dc-default-rtdb.firebaseio.com",
            projectId: "data-manager-af3dc",
            storageBucket: "data-manager-af3dc.firebasestorage.app",
            messagingSenderId: "140237513200",
            appId: "1:140237513200:web:2dd854ee93827d36d1fd35"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        const SESSION_DURATION = 5 * 60 * 1000; 

        let currentUser = null;
        let currentCategory = localStorage.getItem('vault_active_category') || 'dashboard'; 
        let itemsData = {};
        let viewMode = 'grid';
        let editingId = null;
        let viewingId = null; 

        const authScreen = document.getElementById('auth-screen');
        const appScreen = document.getElementById('app-screen');
        const loginForm = document.getElementById('login-form');
        const bottomNavbar = document.getElementById('bottom-navbar');
        const startupLoader = document.getElementById('startup-loader');

        // Restore Settings
        const savedBg = localStorage.getItem('vault_custom_bg');
        if(savedBg) document.body.style.backgroundImage = `url('${savedBg}')`;
        
        const savedContentBg = localStorage.getItem('vault_content_bg');
        if(savedContentBg) {
             const appScreen = document.getElementById('app-screen');
             appScreen.style.backgroundImage = `linear-gradient(rgba(15, 23, 42, 0.7), rgba(15, 23, 42, 0.8)), url('${savedContentBg}')`;
             appScreen.style.backgroundSize = "cover";
             appScreen.style.backgroundPosition = "center";
        }

        const savedLogo = localStorage.getItem('vault_custom_logo');
        if(savedLogo) document.getElementById('dynamic-favicon').href = savedLogo;

        const initialHeight = window.innerHeight;
        window.addEventListener('resize', () => {
            const currentHeight = window.innerHeight;
            if (currentHeight < initialHeight * 0.8) {
                bottomNavbar.style.display = 'none';
            } else {
                bottomNavbar.style.display = 'grid';
            }
        });

        // AUTH & SESSION MANAGEMENT
        onAuthStateChanged(auth, (user) => {
            if (user) {
                const lastActive = localStorage.getItem('vault_last_active');
                const now = Date.now();
                if (lastActive && (now - parseInt(lastActive)) < SESSION_DURATION) {
                    proceedToApp(user);
                } else {
                    if (!lastActive) {
                         signOut(auth).then(() => showLoginScreen());
                    } else {
                        localStorage.removeItem('vault_last_active');
                        signOut(auth).then(() => showLoginScreen());
                    }
                }
            } else {
                showLoginScreen();
            }
        });

        function showLoginScreen() {
            currentUser = null;
            startupLoader.style.opacity = '0';
            setTimeout(() => startupLoader.style.display = 'none', 500);
            authScreen.classList.remove('hidden');
            appScreen.classList.add('hidden');
        }

        function proceedToApp(user) {
            currentUser = user;
            localStorage.setItem('vault_last_active', Date.now());
            startupLoader.style.opacity = '0';
            setTimeout(() => startupLoader.style.display = 'none', 500);
            authScreen.classList.add('hidden');
            appScreen.classList.remove('hidden');
            document.getElementById('user-email').textContent = user.email;
            loadProfilePic(user.uid);
            const savedCat = localStorage.getItem('vault_active_category') || 'dashboard';
            switchCategory(savedCat);
            document.addEventListener('visibilitychange', () => {
                if(document.visibilityState === 'hidden') localStorage.setItem('vault_last_active', Date.now());
            });
            setInterval(() => localStorage.setItem('vault_last_active', Date.now()), 60000);
        }

        function loadProfilePic(uid) {
            onValue(ref(db, `users/${uid}/profilePic`), (snap) => {
                const url = snap.val();
                const settingsAvatar = document.getElementById('settings-avatar');
                const settingsIcon = document.getElementById('settings-icon');
                if(url) { settingsAvatar.src = url; settingsAvatar.classList.remove('hidden'); settingsIcon.classList.add('hidden'); } 
                else { settingsAvatar.classList.add('hidden'); settingsIcon.classList.remove('hidden'); }
            });
        }

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const btn = loginForm.querySelector('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner w-4 h-4 border-2"></span>';
            btn.disabled = true;
            signInWithEmailAndPassword(auth, email, pass)
                .then(() => localStorage.setItem('vault_last_active', Date.now()))
                .catch(err => {
                    document.getElementById('auth-msg').textContent = "Incorrect email or password.";
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
        });

        // --- GLOBAL FUNCTIONS ---
        window.logout = () => { localStorage.removeItem('vault_last_active'); signOut(auth); };

        window.togglePassVisibility = (el) => {
            const input = document.getElementById('inp-password');
            if (input.type === "password") { input.type = "text"; el.classList.remove('fa-eye'); el.classList.add('fa-eye-slash'); } 
            else { input.type = "password"; el.classList.remove('fa-eye-slash'); el.classList.add('fa-eye'); }
        };

        // --- VISUAL ASSETS SETTINGS ---
        window.saveBackground = () => {
            const url = document.getElementById('custom-bg-input').value;
            if(url) {
                document.body.style.backgroundImage = `url('${url}')`;
                localStorage.setItem('vault_custom_bg', url);
                showToast("Body BG Updated");
            }
        };
        window.resetBackground = () => {
            document.body.style.backgroundImage = '';
            localStorage.removeItem('vault_custom_bg');
            document.getElementById('custom-bg-input').value = '';
            showToast("Body BG Reset");
        };

        window.saveContentBg = () => {
            const url = document.getElementById('content-bg-input').value;
            if(url) {
                const appScreen = document.getElementById('app-screen');
                appScreen.style.backgroundImage = `linear-gradient(rgba(15, 23, 42, 0.7), rgba(15, 23, 42, 0.8)), url('${url}')`;
                appScreen.style.backgroundSize = "cover";
                appScreen.style.backgroundPosition = "center";
                localStorage.setItem('vault_content_bg', url);
                showToast("Content BG Updated");
            }
        };
        window.resetContentBg = () => {
             const appScreen = document.getElementById('app-screen');
             appScreen.style.backgroundImage = '';
             localStorage.removeItem('vault_content_bg');
             document.getElementById('content-bg-input').value = '';
             showToast("Content BG Reset");
        };

        window.saveLogo = () => {
            const url = document.getElementById('custom-logo-input').value;
            if(url) {
                document.getElementById('dynamic-favicon').href = url;
                localStorage.setItem('vault_custom_logo', url);
                showToast("Logo Updated");
            }
        };
        window.resetLogo = () => {
             document.getElementById('dynamic-favicon').href = '';
             localStorage.removeItem('vault_custom_logo');
             document.getElementById('custom-logo-input').value = '';
             showToast("Logo Reset");
        };

        function resetModalState() {
            document.querySelectorAll('#entry-form input, #entry-form textarea').forEach(el => el.readOnly = false);
            document.getElementById('btn-save').classList.remove('hidden');
            document.getElementById('toggle-pass-btn').classList.remove('hidden');
            document.querySelectorAll('.modal-copy-btn').forEach(btn => btn.classList.add('hidden'));
            document.getElementById('inp-password').type = "password";
            const eyeIcon = document.getElementById('toggle-pass-btn');
            eyeIcon.classList.remove('fa-eye-slash'); eyeIcon.classList.add('fa-eye');
        }

        // --- FIXED: OPEN MODAL FUNCTION ---
        window.openModal = () => {
            editingId = null; viewingId = null;
            resetModalState();
            document.getElementById('entry-form').reset();
            draftIds.forEach(id => {
                const savedVal = localStorage.getItem('draft_' + id);
                if(savedVal) { const el = document.getElementById(id); if(el) el.value = savedVal; }
            });
            document.getElementById('modal-title').textContent = "New Entry";
            const modal = document.getElementById('main-modal');
            const content = document.getElementById('modal-content');
            document.getElementById('modal-cat-select').classList.remove('hidden');
            content.classList.remove('max-w-[340px]', 'p-5');
            content.classList.add('w-full', 'h-full', 'max-w-none', 'rounded-2xl', 'p-6');
            modal.classList.remove('hidden');
            const typeToSet = currentCategory === 'dashboard' ? 'notes' : currentCategory;
            window.setModalType(typeToSet);
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
        };

        window.closeModal = () => {
            const modal = document.getElementById('main-modal');
            const content = document.getElementById('modal-content');
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => { modal.classList.add('hidden'); editingId = null; viewingId = null; }, 300);
        };

        window.setModalType = (type) => {
            document.querySelectorAll('.modal-cat-btn').forEach(btn => {
                const txt = btn.textContent.toLowerCase().trim();
                let match = type;
                if(type === 'photos') match = 'img';
                if(type === 'credentials') match = 'user'; 
                if(type === 'apis') match = 'api';
                if(txt.includes(match.slice(0,3))) {
                    btn.classList.remove('bg-slate-800', 'text-slate-400', 'hover:bg-slate-700', 'border-slate-700');
                    btn.classList.add('bg-[var(--accent-color)]', 'text-white', 'border-transparent', 'shadow-lg');
                } else {
                    btn.classList.add('bg-slate-800', 'text-slate-400', 'hover:bg-slate-700', 'border-slate-700');
                    btn.classList.remove('bg-[var(--accent-color)]', 'text-white', 'border-transparent', 'shadow-lg');
                }
            });
            document.querySelectorAll('.field-group').forEach(grp => {
                if(grp.dataset.for === type) grp.classList.remove('hidden');
                else grp.classList.add('hidden');
            });
        };

        window.viewItem = (id) => {
            const item = itemsData[id]; if(!item) return;
            viewingId = id; editingId = null;
            const modal = document.getElementById('main-modal');
            const content = document.getElementById('modal-content');
            document.getElementById('modal-cat-select').classList.add('hidden');
            content.classList.remove('max-w-[340px]', 'p-5');
            content.classList.add('w-full', 'h-full', 'max-w-none', 'rounded-2xl', 'p-6');
            document.querySelectorAll('#entry-form input, #entry-form textarea').forEach(el => el.readOnly = true);
            document.getElementById('btn-save').classList.add('hidden');
            document.getElementById('toggle-pass-btn').classList.add('hidden');
            document.getElementById('inp-password').type = "text"; 
            document.querySelectorAll('.modal-copy-btn').forEach(btn => btn.classList.remove('hidden'));
            document.getElementById('modal-title').textContent = "View Entry";
            document.getElementById('entry-id').value = id;
            document.getElementById('inp-title').value = item.title || "";
            window.setModalType(currentCategory);
            
            if(currentCategory === 'notes') document.getElementById('inp-content').value = item.content || "";
            else if(currentCategory === 'apis') {
                document.getElementById('inp-api-url').value = item.apiUrl || "";
                document.getElementById('inp-api-email').value = item.apiEmail || "";
                document.getElementById('inp-api-key').value = item.apiKey || "";
            }
            else if(currentCategory === 'links') document.getElementById('inp-url').value = item.url || "";
            else if(currentCategory === 'photos') document.getElementById('inp-img-url').value = item.imgUrl || "";
            else if(currentCategory === 'credentials') {
                document.getElementById('inp-username').value = item.username || "";
                document.getElementById('inp-password').value = item.password || "";
                document.getElementById('inp-cred-url').value = item.url || "";
            }
            modal.classList.remove('hidden');
            setTimeout(() => { content.classList.remove('scale-95', 'opacity-0'); content.classList.add('scale-100', 'opacity-100'); }, 10);
        };

        window.editItem = (id) => {
            const item = itemsData[id]; if(!item) return;
            resetModalState(); 
            const modal = document.getElementById('main-modal');
            const content = document.getElementById('modal-content');
            document.getElementById('modal-cat-select').classList.add('hidden');
            content.classList.remove('max-w-[340px]', 'p-5');
            content.classList.add('w-full', 'h-full', 'max-w-none', 'rounded-2xl', 'p-6'); 
            modal.classList.remove('hidden');
            setTimeout(() => { content.classList.remove('scale-95', 'opacity-0'); content.classList.add('scale-100', 'opacity-100'); }, 10);
            editingId = id; viewingId = null;
            document.getElementById('modal-title').textContent = "Edit Entry";
            document.getElementById('entry-id').value = id;
            document.getElementById('inp-title').value = item.title || "";
            window.setModalType(currentCategory);
            
            if(currentCategory === 'notes') document.getElementById('inp-content').value = item.content || "";
            else if(currentCategory === 'apis') {
                document.getElementById('inp-api-url').value = item.apiUrl || "";
                document.getElementById('inp-api-email').value = item.apiEmail || "";
                document.getElementById('inp-api-key').value = item.apiKey || "";
            }
            else if(currentCategory === 'links') document.getElementById('inp-url').value = item.url || "";
            else if(currentCategory === 'photos') document.getElementById('inp-img-url').value = item.imgUrl || "";
            else if(currentCategory === 'credentials') {
                document.getElementById('inp-username').value = item.username || "";
                document.getElementById('inp-password').value = item.password || "";
                document.getElementById('inp-cred-url').value = item.url || "";
            }
        };

        window.deleteItem = async (id) => {
            if(confirm('Are you sure you want to delete this item?')) {
                try { await remove(ref(db, `users/${currentUser.uid}/${currentCategory}/${id}`)); showToast('Item deleted'); } catch(e) { alert(e.message); }
            }
        };

        window.copyFromId = (id) => { const el = document.getElementById(id); if(el) copyToClip(el.value); };

        window.switchCategory = (cat) => {
            currentCategory = cat;
            localStorage.setItem('vault_active_category', cat);
            const searchInput = document.getElementById('search-input');
            searchInput.value = ''; 
            
            document.querySelectorAll('.mobile-nav-btn').forEach(btn => {
                const txt = btn.textContent.toLowerCase().trim();
                let match = cat;
                if(cat === 'dashboard') match = 'home';
                if(cat === 'photos') match = 'img';
                if(cat === 'credentials') match = 'user'; 
                if(cat === 'apis') match = 'api';
                if(cat === 'links') match = 'link';
                if(cat === 'notes') match = 'note';
                
                btn.classList.remove('bg-[var(--accent-color)]', 'text-white', 'shadow-lg');
                btn.classList.add('text-slate-400');
                btn.style.backgroundColor = '';
                
                if(txt.includes(match)) {
                    btn.classList.remove('dynamic-bg');
                    btn.classList.add('bg-[var(--accent-color)]', 'text-white', 'shadow-lg');
                    btn.classList.remove('text-slate-400');
                } else {
                    btn.classList.add('dynamic-bg');
                }
            });

            const dashboard = document.getElementById('dashboard-view');
            const listHeader = document.getElementById('list-header');
            const contentGrid = document.getElementById('content-grid');
            const emptyState = document.getElementById('empty-state');
            if(cat === 'dashboard') {
                dashboard.classList.remove('hidden');
                listHeader.classList.add('hidden');
                contentGrid.classList.add('hidden');
                emptyState.classList.add('hidden');
                searchInput.disabled = false; 
                searchInput.style.opacity = "1";
                loadDashboardStats();
            } else {
                dashboard.classList.add('hidden');
                listHeader.classList.remove('hidden');
                searchInput.disabled = false;
                searchInput.style.opacity = "1";
                document.getElementById('page-title').textContent = cat === 'apis' ? 'API Store' : cat;
                loadData();
            }
        };

        function formatBytes(bytes, decimals = 2) {
            if (!+bytes) return '0 KB';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['KB', 'MB', 'GB', 'TB'];
            if(bytes < 1024) return (bytes / 1024).toFixed(3) + " KB";
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            const sizesFull = ['Bytes', 'KB', 'MB', 'GB'];
            const iFull = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, iFull)).toFixed(dm))} ${sizesFull[iFull]}`;
        }

        function calculateObjectSize(obj, type) {
            let str = "";
            if(!obj) return 0;
            if (type === 'notes') str = (obj.title||"") + (obj.content||"");
            else if (type === 'links') str = (obj.title||"") + (obj.url||"");
            else if (type === 'photos') str = (obj.title||"") + (obj.imgUrl||"");
            else if (type === 'credentials') str = (obj.title||"") + (obj.username||"") + (obj.password||"") + (obj.url||"");
            else if (type === 'apis') str = (obj.title||"") + (obj.apiUrl||"") + (obj.apiKey||"") + (obj.apiEmail||"");
            return new Blob([str]).size;
        }

        function loadDashboardStats() {
            if(!currentUser) return;
            const refAll = ref(db, `users/${currentUser.uid}`);
            onValue(refAll, (snap) => {
                const data = snap.val() || {};
                document.getElementById('count-notes').textContent = data.notes ? Object.keys(data.notes).length : 0;
                document.getElementById('count-links').textContent = data.links ? Object.keys(data.links).length : 0;
                document.getElementById('count-photos').textContent = data.photos ? Object.keys(data.photos).length : 0;
                document.getElementById('count-credentials').textContent = data.credentials ? Object.keys(data.credentials).length : 0;
                document.getElementById('count-apis').textContent = data.apis ? Object.keys(data.apis).length : 0;

                let totalBytes = 0;
                let notesBytes = 0; Object.values(data.notes || {}).forEach(i => notesBytes += calculateObjectSize(i, 'notes')); document.getElementById('size-notes').textContent = formatBytes(notesBytes); totalBytes += notesBytes;
                let linksBytes = 0; Object.values(data.links || {}).forEach(i => linksBytes += calculateObjectSize(i, 'links')); document.getElementById('size-links').textContent = formatBytes(linksBytes); totalBytes += linksBytes;
                let photosBytes = 0; Object.values(data.photos || {}).forEach(i => photosBytes += calculateObjectSize(i, 'photos')); document.getElementById('size-photos').textContent = formatBytes(photosBytes); totalBytes += photosBytes;
                let credsBytes = 0; Object.values(data.credentials || {}).forEach(i => credsBytes += calculateObjectSize(i, 'credentials')); document.getElementById('size-credentials').textContent = formatBytes(credsBytes); totalBytes += credsBytes;
                let apisBytes = 0; Object.values(data.apis || {}).forEach(i => apisBytes += calculateObjectSize(i, 'apis')); document.getElementById('size-apis').textContent = formatBytes(apisBytes); totalBytes += apisBytes;

                document.getElementById('total-storage').textContent = formatBytes(totalBytes);
            });
        }

        window.toggleSettings = () => {
            const panel = document.getElementById('settings-panel');
            const backdrop = document.getElementById('settings-backdrop');
            if (panel.classList.contains('open')) {
                panel.classList.remove('open');
                backdrop.classList.add('hidden');
            } else {
                panel.classList.add('open');
                backdrop.classList.remove('hidden');
            }
        };

        window.toggleView = (mode) => {
            const grid = document.getElementById('content-grid');
            if(mode === 'list') { grid.classList.remove('grid-cols-2'); grid.classList.add('grid-cols-1'); }
            else { grid.classList.add('grid-cols-2'); grid.classList.remove('grid-cols-1'); }
        };

        function loadData() {
            if (!currentUser || currentCategory === 'dashboard') return;
            document.getElementById('loader-state').classList.remove('hidden');
            document.getElementById('content-grid').classList.add('hidden');
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('item-count').textContent = 'Syncing...';
            const dataRef = ref(db, `users/${currentUser.uid}/${currentCategory}`);
            onValue(dataRef, (snapshot) => {
                const grid = document.getElementById('content-grid');
                grid.innerHTML = '';
                itemsData = snapshot.val() || {};
                const itemsArray = Object.entries(itemsData).map(([key, val]) => ({id: key, ...val}));
                itemsArray.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                
                let catTotalBytes = 0;
                itemsArray.forEach(i => catTotalBytes += calculateObjectSize(i, currentCategory));
                
                const query = document.getElementById('search-input').value.toLowerCase();
                const filtered = itemsArray.filter(i => (i.title || "Untitled").toLowerCase().includes(query));
                
                document.getElementById('loader-state').classList.add('hidden');
                document.getElementById('item-count').innerHTML = `${filtered.length} entries <span class="ml-2 px-1.5 py-0.5 rounded bg-emerald-500/20 text-emerald-400 font-bold border border-emerald-500/20 text-[9px]">${formatBytes(catTotalBytes)}</span>`;
                
                if (filtered.length === 0) {
                    document.getElementById('content-grid').classList.add('hidden');
                    document.getElementById('empty-state').classList.remove('hidden');
                } else {
                    document.getElementById('empty-state').classList.add('hidden');
                    document.getElementById('content-grid').classList.remove('hidden');
                    filtered.forEach(item => grid.appendChild(createCard(item)));
                }
            });
        }

        function createCard(item) {
            const div = document.createElement('div');
            const safe = (txt) => (txt || "").replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n');
            const titleSafe = safe(item.title);
            let catName = currentCategory;
            if(catName === 'credentials') catName = 'User';
            if(catName === 'photos') catName = 'Image';
            if(catName === 'links') catName = 'Link';
            if(catName === 'notes') catName = 'Note';
            if(catName === 'apis') catName = 'API';
            const displayTitle = item.title ? item.title : `Untitled ${catName}`;
            
            div.className = "glass-card p-4 rounded-xl flex flex-col h-full relative group cursor-pointer active:scale-[0.98]";
            div.onclick = (e) => { if(e.target.closest('button')) return; viewItem(item.id); };
            
            const bytes = calculateObjectSize(item, currentCategory);
            const sizeStr = formatBytes(bytes);
            const sizeInfo = `<span class="ml-2 px-1.5 py-0.5 rounded bg-emerald-500/20 border border-emerald-500/20 text-[8px] text-emerald-400 font-mono tracking-tight shrink-0 select-none">${sizeStr}</span>`;

            const header = `<div class="flex justify-between items-start mb-3"><div class="flex items-center gap-2 overflow-hidden pr-2 w-full"><i class="fa-solid fa-folder-open text-[var(--accent-color)] opacity-70 text-xs shrink-0"></i><div class="flex items-center overflow-hidden flex-1"><h3 class="font-bold text-sm text-slate-100 truncate cursor-text select-text ${!item.title ? 'italic text-slate-500' : ''}">${displayTitle}</h3>${sizeInfo}</div><button onclick="event.stopPropagation(); copyToClip('${titleSafe}')" class="text-slate-500 hover:text-white transition px-2 shrink-0"><i class="fa-regular fa-copy text-xs"></i></button></div></div>`;
            const dateStr = new Date(item.createdAt).toLocaleDateString('en-US');
            const footer = `<div class="mt-auto pt-3 border-t border-white/5 flex justify-between items-center"><p class="text-[10px] text-sky-400 font-bold tracking-wider">${dateStr}</p><div class="flex gap-3"><button onclick="event.stopPropagation(); editItem('${item.id}')" class="text-blue-400 hover:text-blue-300 transition text-base p-1"><i class="fa-solid fa-pen-to-square"></i></button><button onclick="event.stopPropagation(); deleteItem('${item.id}')" class="text-rose-400 hover:text-rose-300 transition text-base p-1"><i class="fa-solid fa-trash"></i></button></div></div>`;

            let bodyHtml = '';
            if (currentCategory === 'notes') { bodyHtml = `<div class="relative group/content mb-2 pointer-events-none"><div class="text-xs text-slate-300 whitespace-pre-wrap font-mono line-clamp-6 leading-relaxed bg-slate-900/30 p-2 rounded-lg border border-white/5 pr-6">${item.content || ''}</div></div>`; } 
            else if (currentCategory === 'apis') {
                const emailHtml = item.apiEmail ? `<div class="bg-slate-900/60 p-2 rounded-lg border border-white/5 mb-2"><span class="text-[9px] text-slate-500 uppercase font-bold block">Email</span><span class="font-mono text-xs text-indigo-300 truncate block">${item.apiEmail}</span></div>` : '';
                bodyHtml = `<div class="space-y-2 mb-2 pointer-events-none">${emailHtml}<div class="bg-slate-900/50 p-2 rounded border border-white/5 relative group/url"><p class="text-[10px] text-slate-500 uppercase font-bold mb-0.5">Key/Token Preview</p><div class="text-[10px] font-mono text-cyan-300 break-all pr-5 line-clamp-2">${item.apiKey ? item.apiKey.substring(0,20)+'...' : 'No Key'}</div></div></div>`;
            } else if (currentCategory === 'links') { bodyHtml = `<div class="relative mb-2"><div class="flex items-center gap-2 bg-slate-900/30 p-2 rounded border border-white/5"><i class="fa-solid fa-link text-xs text-slate-500"></i><span class="text-[10px] text-indigo-300 truncate flex-1">${item.url}</span></div></div>`; } 
            else if (currentCategory === 'photos') { bodyHtml = `<div class="relative group/img aspect-video bg-slate-900 rounded-lg overflow-hidden mb-2 border border-white/10 shadow-inner pointer-events-none"><img src="${item.imgUrl}" onerror="this.src='https://placehold.co/600x400/1e293b/FFF?text=Image+Broken'" class="w-full h-full object-cover"></div>`; } 
            else if (currentCategory === 'credentials') {
                const urlHtml = item.url ? `<div class="bg-slate-900/60 p-2 rounded-lg border border-white/5 mb-2"><span class="text-[9px] text-slate-500 uppercase font-bold block">Site</span><span class="font-mono text-xs text-indigo-300 truncate block">${item.url}</span></div>` : '';
                bodyHtml = `<div class="text-sm mb-2 pointer-events-none">${urlHtml}<div class="bg-slate-900/60 p-2 rounded-lg border border-white/5 flex items-center justify-between"><div><span class="text-[9px] text-slate-500 uppercase font-bold block">User</span><span class="font-mono text-xs text-slate-300">${item.username}</span></div></div></div>`;
            }
            div.innerHTML = header + bodyHtml + footer; return div;
        }

        window.setCustomColor = (type) => {
            const val = prompt("Enter Color Code (Hex or RGBA):", "#000000"); if(!val) return;
            if(type === 'accent') setAccent(val); else if(type === 'card') setCardBg(val);
            else if(type === 'main') { let glassVal = val; if(val.startsWith('#') && val.length === 7) glassVal = val + 'E6'; setGlassBg(glassVal, val); }
        }

        window.toggleDropdown = (contentId, iconId) => {
            const content = document.getElementById(contentId); const icon = document.getElementById(iconId);
            if(content.classList.contains('open')) { content.classList.remove('open'); icon.classList.remove('open'); } 
            else { content.classList.add('open'); icon.classList.add('open'); }
        };

        window.backupData = async () => { if(!currentUser) return; const snap = await get(ref(db, `users/${currentUser.uid}`)); const data = snap.val(); if(!data) return showToast("No data"); const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data)); a.download = "backup.json"; a.click(); };
        
        const draftIds = ['inp-title', 'inp-content', 'inp-api-url', 'inp-api-email', 'inp-api-key', 'inp-url', 'inp-img-url', 'inp-cred-url', 'inp-username', 'inp-password'];
        draftIds.forEach(id => {
            const el = document.getElementById(id);
            if(el) { el.addEventListener('input', (e) => { if(!editingId && !viewingId) localStorage.setItem('draft_' + id, e.target.value); }); }
        });
        function clearDrafts() { draftIds.forEach(id => localStorage.removeItem('draft_' + id)); }

        document.getElementById('entry-form').addEventListener('submit', async (e) => {
            e.preventDefault(); if(viewingId) return;
            let activeCat = currentCategory === 'dashboard' ? 'notes' : currentCategory;
            if(!editingId) {
                document.querySelectorAll('.modal-cat-btn').forEach(btn => { 
                    if(btn.classList.contains('bg-[var(--accent-color)]')) { 
                        const txt = btn.textContent.trim().toLowerCase(); 
                        if(txt.includes('note')) activeCat = 'notes'; else if(txt.includes('link')) activeCat = 'links'; else if(txt.includes('img')) activeCat = 'photos'; else if(txt.includes('user')) activeCat = 'credentials'; else if(txt.includes('api')) activeCat = 'apis'; 
                    } 
                });
            } else { activeCat = currentCategory; }
            const payload = { title: document.getElementById('inp-title').value.trim(), createdAt: editingId ? (itemsData[editingId]?.createdAt || Date.now()) : Date.now() };
            if(activeCat === 'notes') payload.content = document.getElementById('inp-content').value;
            else if(activeCat === 'apis') { payload.apiUrl = document.getElementById('inp-api-url').value; payload.apiEmail = document.getElementById('inp-api-email').value; payload.apiKey = document.getElementById('inp-api-key').value; }
            else if(activeCat === 'links') { payload.url = document.getElementById('inp-url').value; }
            else if(activeCat === 'photos') { payload.imgUrl = document.getElementById('inp-img-url').value; }
            else if(activeCat === 'credentials') { payload.username = document.getElementById('inp-username').value; payload.password = document.getElementById('inp-password').value; payload.url = document.getElementById('inp-cred-url').value; }

            try {
                if (editingId) await update(ref(db, `users/${currentUser.uid}/${activeCat}/${editingId}`), payload);
                else await push(ref(db, `users/${currentUser.uid}/${activeCat}`), payload);
                if(!editingId) clearDrafts();
                closeModal(); showToast('Saved');
                if(activeCat !== currentCategory && currentCategory !== 'dashboard') switchCategory(activeCat);
                if(currentCategory === 'dashboard') loadDashboardStats();
            } catch (err) { alert(err.message); }
        });

        window.setAccent = (c) => { document.documentElement.style.setProperty('--accent-color', c); localStorage.setItem('vault_accent', c); if(currentCategory !== 'dashboard') loadData(); };
        const savedAccent = localStorage.getItem('vault_accent'); if(savedAccent) setAccent(savedAccent);
        window.setGlassBg = (rgba, hex) => { document.documentElement.style.setProperty('--glass-bg', rgba); document.documentElement.style.setProperty('--main-bg', hex); localStorage.setItem('vault_glass_bg', rgba); localStorage.setItem('vault_main_bg', hex); };
        const savedGlass = localStorage.getItem('vault_glass_bg'); const savedMain = localStorage.getItem('vault_main_bg'); if(savedGlass && savedMain) window.setGlassBg(savedGlass, savedMain);
        window.setCardBg = (rgba) => { document.documentElement.style.setProperty('--card-bg', rgba); localStorage.setItem('vault_card_bg', rgba); };
        const savedCardBg = localStorage.getItem('vault_card_bg'); if(savedCardBg) window.setCardBg(savedCardBg);
    </script>
</body>
</html>
